# v3.2 å˜æ›´æ—¥å¿— - JSON + jq æ”¹è¿›

**å‘å¸ƒæ—¥æœŸ**: 2026-02-20  
**ç‰ˆæœ¬**: v3.2 (ä» v3.1 å‡çº§)  
**ä¸»è¦æ”¹è¿›**: ä½¿ç”¨ JSON + jq æ›¿ä»£ Bash è„šæœ¬é…ç½®

## æ ¸å¿ƒæ”¹å˜

### 1. é…ç½®æ ¼å¼å‡çº§

| é¡¹ç›® | v3.1 | v3.2 |
|------|------|------|
| æ˜ å°„è¡¨æ ¼å¼ | `package-map.sh` (Bash è„šæœ¬) | `package-map.json` (JSON æ–‡ä»¶) |
| å¿½ç•¥åˆ—è¡¨æ ¼å¼ | `ignore-packages.sh` (Bash è„šæœ¬) | `ignore-packages.json` (JSON æ–‡ä»¶) |
| é…ç½®å­˜å‚¨ | åˆ†ç¦»çš„ Bash è„šæœ¬ | ç»Ÿä¸€çš„ JSON æ–‡ä»¶ |

### 2. æ–‡ä»¶è·¯å¾„å˜åŒ–

```bash
# v3.1
/opt/actions-runner/compat-scripts/apt-get
/opt/actions-runner/compat-scripts/package-map.sh
/opt/actions-runner/compat-scripts/ignore-packages.sh

# v3.2  
/opt/actions-runner/compat-scripts/apt-get (æ”¹è¿›)
/opt/actions-runner/compat-scripts/package-map.json (æ–°)
/opt/actions-runner/compat-scripts/ignore-packages.json (æ–°)
```

> âš ï¸ **æ³¨æ„**: v3.2 é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ JSON æ–‡ä»¶ï¼Œæ—§çš„ `.sh` æ–‡ä»¶å¯ä»¥æ‰‹åŠ¨åˆ é™¤

### 3. apt-get wrapper æ”¹è¿›

#### v3.1 æ–¹æ³• (Bash è„šæœ¬é…ç½®)
```bash
# åŠ è½½é…ç½®æ–‡ä»¶
if [[ -f "$PACKAGE_MAP_FILE" ]]; then
    source "$PACKAGE_MAP_FILE" 2>/dev/null || true
else
    declare -A PACKAGE_MAP=(...)
fi

# æ£€æŸ¥æ˜ å°„
if [[ -n "${PACKAGE_MAP[$pkg]}" ]]; then
    converted_packages+=("${PACKAGE_MAP[$pkg]}")
fi
```

#### v3.2 æ–¹æ³• (jq æŸ¥è¯¢)
```bash
# å‡½æ•°: ä» JSON è·å–åŒ…æ˜ å°„
get_package_mapping() {
    local package=$1
    if [[ -f "$PACKAGE_MAP_FILE" ]]; then
        jq -r ".\"$package\" // empty" "$PACKAGE_MAP_FILE" 2>/dev/null
    fi
}

# ä½¿ç”¨æ˜ å°„
local mapped_pkg=$(get_package_mapping "$pkg")
```

### 4. é…ç½®æ–‡ä»¶ç¤ºä¾‹å¯¹æ¯”

#### v3.1 - Bash è„šæœ¬æ ¼å¼
```bash
declare -A PACKAGE_MAP=(
    ["libfuse-dev"]="fuse3-devel"
    ["nfs-common"]="nfs-utils"
)

declare -a IGNORE_PACKAGES=(
    "git-annex"
    "git-annex-remote-rclone"
)
```

#### v3.2 - JSON æ ¼å¼
```json
{
  "_version": "3.2",
  "libfuse-dev": "fuse3-devel",
  "nfs-common": "nfs-utils"
}

{
  "_version": "3.2",
  "ignore": [
    "git-annex",
    "git-annex-remote-rclone"
  ]
}
```

## ä¼˜åŠ¿åˆ†æ

### âœ… v3.2 ç›¸å¯¹ v3.1 çš„ä¼˜åŠ¿

1. **æ˜“è¯»æ€§æå‡** â­â­â­
   - JSON æ ¼å¼æ¸…æ™°ï¼Œæ— éœ€æ‡‚ Bash
   - ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨éƒ½èƒ½ç¼–è¾‘
   - JSON éªŒè¯å·¥å…·ä¼—å¤š

2. **ç¼–è¾‘ä¾¿åˆ©æ€§** â­â­â­
   - æ— éœ€æ‡‚ Bash è¯­æ³•
   - é”™è¯¯ç›´æ¥ç”± jq æç¤º
   - `jq` å†…ç½®æ ¼å¼åŒ–éªŒè¯

3. **æ ‡å‡†åŒ–ç¨‹åº¦** â­â­â­
   - JSON æ˜¯ä¸šç•Œæ ‡å‡†æ ¼å¼
   - æ˜“äºé›†æˆåˆ°å…¶ä»–å·¥å…·
   - æ˜“äºç”Ÿæˆå’Œè§£æ

4. **ç‰ˆæœ¬ç®¡ç†** â­â­
   - ä½¿ç”¨ `_version` å­—æ®µæ˜ç¡®ç®¡ç†
   - å‡çº§æ—¶æ›´æ¸…æ™°çš„åˆå¹¶ç­–ç•¥

5. **æ™ºèƒ½åˆå¹¶** â­â­
   - jq æä¾›æ›´å¼ºå¤§çš„åˆå¹¶èƒ½åŠ›
   - é¿å…å› è„šæœ¬è¯­æ³•é—®é¢˜å¯¼è‡´çš„åˆå¹¶å¤±è´¥

### ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§

**ç°æœ‰çš„ v3.1 é…ç½®ä¸ä¼šè¢«åˆ é™¤**

- é¦–æ¬¡è¿è¡Œ v3.2 è„šæœ¬æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„ JSON æ–‡ä»¶
- æ—§çš„ `.sh` æ–‡ä»¶å¯ä»¥æ‰‹åŠ¨ä¿ç•™æˆ–åˆ é™¤
- ä¸¤ä¸ªç‰ˆæœ¬å¯ä»¥çŸ­æœŸå¹¶å­˜

**å‡çº§è·¯å¾„**:
```
è¿è¡Œ v3.2 è„šæœ¬
  â†“
æ£€æµ‹åˆ°ç‰ˆæœ¬å‡çº§
  â†“
å¤‡ä»½æ—§æ–‡ä»¶ (*.bak)
  â†“
åˆ›å»ºæ–° JSON é…ç½®
  â†“
æ™ºèƒ½åˆå¹¶ç”¨æˆ·æ•°æ®
  â†“
æ—§ Bash é…ç½®æ–‡ä»¶å¯é€‰æ‹©åˆ é™¤
```

## åŠŸèƒ½æ–°å¢

### 1. JSON ç‰ˆæœ¬å­—æ®µ

```json
{
  "_version": "3.2",
  "_comment": "è¿™æ˜¯å…ƒæ•°æ®"
}
```

**ç”¨å¤„**: è„šæœ¬ä½¿ç”¨ç‰ˆæœ¬å­—æ®µåˆ¤æ–­æ˜¯å¦éœ€è¦åˆå¹¶æ–°å¢é¡¹

### 2. jq è¯Šæ–­å‘½ä»¤

```bash
apt-get config-info
```

**è¾“å‡º**: æ˜¾ç¤ºå½“å‰åŠ è½½çš„æ‰€æœ‰æ˜ å°„å’Œå¿½ç•¥åŒ…

### 3. æ™ºèƒ½ JSON åˆå¹¶

**v3.1 åˆå¹¶**: ç®€å•çš„å­—ç¬¦ä¸²æ£€æŸ¥ï¼ˆå®¹æ˜“è¯¯åˆ¤ï¼‰  
**v3.2 åˆå¹¶**: å®Œæ•´çš„ jq æŸ¥è¯¢ï¼ˆç²¾ç¡®åˆå¹¶ï¼‰

```bash
# ä¿ç•™ç”¨æˆ·æ·»åŠ çš„æ˜ å°„ï¼Œæ·»åŠ æ–°çš„é»˜è®¤æ˜ å°„
jq -s '. + mapping_update' old.json new_defaults.json
```

### 4. å…ƒæ•°æ®ä¿ç•™

```json
{
  "_comment": "è¿™äº›å­—æ®µè¢« apt-get wrapper å¿½ç•¥",
  "_usage": "ä½†å¯¹äººç±»ç»´æŠ¤è€…å¾ˆæœ‰å¸®åŠ©",
  "_maintenance": "å®ƒä»¬åœ¨ jq æŸ¥è¯¢æ—¶è¢«è¿‡æ»¤æ‰"
}
```

## æ€§èƒ½å½±å“

| æ“ä½œ | v3.1 | v3.2 | å¤‡æ³¨ |
|------|------|------|------|
| å¯åŠ¨é€Ÿåº¦ | å¿« (Bash åŠ è½½) | ç¨æ…¢ (jq è§£æ) | JSON è§£ææ¯” Bash è„šæœ¬æ…¢ ~10-20ms |
| åŒ…è½¬æ¢é€Ÿåº¦ | å¿« (æ•°ç»„æŸ¥è¯¢) | å¿« (jq æŸ¥è¯¢) | jq ä¼˜åŒ–åå·®å¼‚ä¸å¤§ |
| é…ç½®æ–‡ä»¶å¤§å° | ~0.5KB | ~0.7KB | JSON æ ¼å¼ç•¥å ç©ºé—´ |

**ç»“è®º**: æ€§èƒ½å·®å¼‚å¯ä»¥å¿½ç•¥ï¼Œä¼˜åŠ¿æ˜æ˜¾å¤§äºåŠ£åŠ¿

## è¿ç§»å»ºè®®

### å¯¹äºç°æœ‰ç³»ç»Ÿ

**é€‰é¡¹ A: å®Œå…¨å‡çº§ï¼ˆæ¨èï¼‰**
```bash
# 1. å¤‡ä»½ç°æœ‰é…ç½®
cp /opt/actions-runner/compat-scripts/package-map.sh \
   /tmp/package-map.sh.backup

# 2. è¿è¡Œ v3.2 è„šæœ¬
sudo bash setup-rocky-9.4-ci-env-v3.2.sh

# 3. éªŒè¯æ–°é…ç½®
apt-get config-info

# 4. åˆ é™¤æ—§é…ç½®ï¼ˆå¯é€‰ï¼‰
rm /opt/actions-runner/compat-scripts/*.sh.bak
```

**é€‰é¡¹ B: é€æ­¥å‡çº§**
```bash
# 1. è¿è¡Œ v3.2 è„šæœ¬ï¼ˆå¹¶å­˜ï¼‰
sudo bash setup-rocky-9.4-ci-env-v3.2.sh

# 2. éªŒè¯ JSON é…ç½®
jq . /opt/actions-runner/compat-scripts/package-map.json

# 3. æµ‹è¯•å·¥ä½œæµç¨‹
apt-get install libfuse-dev

# 4. æ»¡è¶³ååˆ é™¤æ—§æ–‡ä»¶
rm /opt/actions-runner/compat-scripts/package-map.sh
rm /opt/actions-runner/compat-scripts/ignore-packages.sh
```

## å·²çŸ¥é™åˆ¶

1. **jq ä¾èµ–**: ç³»ç»Ÿå¿…é¡»å®‰è£… jqï¼ˆv3.2 è„šæœ¬å·²åœ¨å‰ç½®æ­¥éª¤ä¸­å®‰è£…ï¼‰
2. **JSON å¤§å°**: ä¸é€‚åˆè¶…å¤§é…ç½®ï¼ˆä½†è¿™åœ¨å®è·µä¸­ä¸æ˜¯é—®é¢˜ï¼‰
3. **å®æ—¶ç¼–è¾‘**: ç¼–è¾‘é…ç½®æ–‡ä»¶åéœ€è¦æ‰‹åŠ¨é‡æ–°åŠ è½½ï¼ˆè¿è¡Œ apt-get å‘½ä»¤ï¼‰

## æµ‹è¯•æ¸…å•

- [ ] JSON é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡® (`jq . *.json`)
- [ ] apt-get è¯Šæ–­å‘½ä»¤å·¥ä½œ (`apt-get config-info`)
- [ ] åŒ…åè½¬æ¢æ­£å¸¸ (`apt-get install libfuse-dev`)
- [ ] å¿½ç•¥åˆ—è¡¨å·¥ä½œ (`apt-get install git-annex` è¢«è·³è¿‡)
- [ ] è„šæœ¬é‡æ–°è¿è¡Œé…ç½®ä¿ç•™
- [ ] å…ƒæ•°æ®æŸ¥è¯¢å·¥ä½œ (`jq '._comment'`)

## åé¦ˆæ¸ é“

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. JSON æ ¼å¼: `jq . /opt/actions-runner/compat-scripts/package-map.json`
2. é…ç½®åŠ è½½: `apt-get config-info`
3. åŒ…è½¬æ¢é€»è¾‘: `bash -x /opt/actions-runner/compat-scripts/apt-get install test-pkg`

## ä¸‹ä¸€ç‰ˆæœ¬è®¡åˆ’ (v3.3+)

- [ ] æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼åŒ…ååŒ¹é…
- [ ] ç¯å¢ƒå˜é‡åœ¨é…ç½®ä¸­çš„æ”¯æŒ
- [ ] é…ç½®çƒ­é‡è½½
- [ ] åŒ…è½¬æ¢æ—¥å¿—è®°å½•
- [ ] Web UI é…ç½®ç¼–è¾‘å™¨

---

**å‡çº§å®Œæˆ**ï¼ç°åœ¨äº«å— JSON é…ç½®çš„ä¼˜åŠ¿å§ ğŸ‰
