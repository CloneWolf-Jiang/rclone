# 部署流程改写计划

## 📋 文档更新方案

基于对 Rocky 9.4 与两个仓库 CI/CD 兼容性的分析，需要对原有的部署流程文档进行以下改写：

---

## 🔄 改写步骤

### **步骤 1: 调整文档结构**

**原始结构** (7个阶段):
```
第 1 阶段: 安装操作系统
第 2 阶段: 配置网络
第 3 阶段: 禁用 SELinux
第 4 阶段: 创建 Runner 用户
第 5 阶段: 下载与安装 Runner
第 6 阶段: 配置 Runner
第 7 阶段: 启动 Runner 服务
```

**新结构** (8个阶段，在前面插入):
```
第 0 阶段: Rocky 9.4 CI/CD 环境准备 [新增]
  └─ 运行 setup-rocky-9.4-ci-env.sh
  └─ 验证关键依赖

第 1 阶段: 安装操作系统
  ...(保持不变)

第 2 阶段: 配置网络
  ...(保持不变)

第 3 阶段: 禁用 SELinux
  ...(保持不变)

第 4 阶段: 创建 Runner 用户
  ...(保持不变)

第 5 阶段: 下载与安装 Runner
  ...(保持不变)

第 6 阶段: 配置 Runner
  ...(保持不变)

第 7 阶段: 启动 Runner 服务
  ...(保持不变)

第 8 阶段: 验证 CI/CD 兼容性 [新增]
  └─ 验证已知兼容性问题
  └─ 测试构建流程
```

---

### **步骤 2: 添加第 0 阶段内容**

在 HTML 文档中，插入新的 `<h3>` 部分，内容包括：

```html
<h3>第 0 阶段：Rocky Linux 9.4 CI/CD 环境准备</h3>

<p>这个步骤专门针对 Rocky Linux 9.4 系统，用来安装和配置必要的编译工具和依赖。
如果你计划在这个 Runner 上运行 rclone 或 amlogic-s9xxx-openwrt 项目的 CI/CD 流程，
必须先完成此步骤。</p>

<h4>为什么需要第 0 阶段？</h4>

<p>虽然 Rocky Linux 9.7 提供了很好的基础，但默认安装中缺少一些特定工具：</p>

<ul>
  <li><strong>编译工具</strong>: gcc, g++, make 等 (OpenWrt 编译必需)</li>
  <li><strong>文件系统工具</strong>: btrfs-progs (amlogic 脚本需要)</li>
  <li><strong>性能工具</strong>: pigz (并行压缩，可选但推荐)</li>
  <li><strong>开发库</strong>: libfdt-devel, libncurses-devel 等</li>
</ul>

<h4>执行步骤</h4>

<p><strong>前提条件：</strong></p>
<ul>
  <li>Rocky Linux 9.4 或更高版本已安装完成</li>
  <li>拥有 root 权限或 sudo 访问</li>
  <li>网络连接正常</li>
</ul>

<p><strong>运行环境初始化脚本：</strong></p>

<div class="code-block">
# 下载环境初始化脚本（已包含在仓库中）
cd ~/amlogic-s9xxx-openwrt/附录
# 或者从 rclone 仓库根目录的 附录 文件夹找到

# 执行脚本（会自动识别并安装所有依赖）
sudo bash setup-rocky-9.4-ci-env.sh
</div>

<p><strong>脚本会自动进行以下操作：</strong></p>
<ol>
  <li>✅ 检查系统版本和网络连接</li>
  <li>✅ 运行 dnf update 更新包管理器</li>
  <li>✅ 安装编译工具链 (gcc, g++, make, bison, flex, etc)</li>
  <li>✅ 安装文件系统工具 (btrfs-progs, pigz, util-linux, lvm2, etc)</li>
  <li>✅ 安装开发库 (libfdt-devel, libncurses-devel, openssl-devel, etc)</li>
  <li>✅ 验证 runner 用户的 sudoer 权限</li>
  <li>✅ 最后验证所有关键工具</li>
</ol>

<p style="color: #d32f2f;"><strong>⏱️ 预计耗时：</strong> 5-10 分钟（取决于网络速度和磁盘 I/O）</p>

<p><strong>磁盘空间需求：</strong> ~800MB 用于安装包</p>

<h4>验证安装</h4>

<p>脚本执行完毕后，应该看到如下输出：</p>

<div class="code-block">
============================================
安装总结
============================================

✅ 所有关键工具已成功安装
✅ 系统已准备好进行 rclone 和 OpenWrt 编译

ℹ️  系统信息:
  - 操作系统: Rocky Linux 9.7 (Blue Onyx)
  - Linux 内核: 5.14.0-...
  - CPU 核数: 4
  - 可用内存: 6.2Gi
  - 磁盘空间: 200G 可用
</div>

<h4>如果脚本报错</h4>

<p>如果遇到个别工具安装失败，可以手动安装：</p>

<div class="code-block">
# 安装单个工具示例
sudo dnf install -y btrfs-progs pigz

# 或安装整个编译工具组
sudo dnf groupinstall -y "Development Tools"
</div>

<div class="info-box warning">
  <p><strong>⚠️ 如果在之前的步骤中已经创建了 runner 用户或启动了 systemd 服务，
  请不要重新运行第 0 阶段的脚本。该脚本只能在 Runner 完全部署前运行。</strong></p>
  
  <p>如果 Runner 已在运行，需要的额外依赖可以单独安装，例如：</p>
  
  <div class="code-block">
  sudo dnf install -y btrfs-progs pigz python3-devel
  </div>
</div>
```

---

### **步骤 3: 更新第 1 阶段的分区建议**

在"硬盘空间分配规划"部分，添加说明：

```text
⚠️ 注意：本文档使用 ext4 文件系统的标准分区方案。
   如果你的系统已安装为 XFS + LVM（Rocky 默认），虽然兼容性略有不同，
   但仍可正常使用。详见附录"Rocky-9.4-兼容性适配方案.md"。
```

---

### **步骤 4: 在第 7 阶段后添加第 8 阶段**

```html
<h3>第 8 阶段：验证 CI/CD 兼容性（可选但推荐）</h3>

<p>部署完成后，为了确保 Runner 能正常执行 rclone 和 amlogic-s9xxx-openwrt 的 CI/CD 任务，
建议进行以下验证。</p>

<h4>兼容性验证清单</h4>

<div class="code-block">
# 1. 验证编译工具
gcc --version        # 应显示 11.x 或更高
make --version       # 应显示 4.x
python3 --version    # 应显示 3.9 或更高

# 2. 验证文件系统工具
btrfs --version      # 应正常输出
pigz --version       # 应正常输出
losetup --version    # 应正常输出（losetup 由 util-linux 提供）

# 3. 验证开发库
find /usr/include -name "fdt.h"          # 应找到 libfdt 头文件
find /usr/include -name "ncurses.h"      # 应找到 ncurses 头文件
</div>

<h4>测试构建流程（可选）</h4>

<p>如果想确保 OpenWrt 编译能正常工作，可以尝试运行一个简单的构建测试：</p>

<div class="code-block">
# 以 runner 用户身份运行测试
sudo -u runner bash -c '
  cd /tmp
  git clone --depth 1 https://github.com/openwrt/openwrt.git
  cd openwrt
  ./scripts/feeds update -a
  ./scripts/feeds install -a
  # 这会下载大量文件并创建编译环境，但不会完全编译（会耗时很长）
'
</div>

<div class="info-box success">
  <p><strong>✅ 如果以上命令都成功执行，说明系统已完全准备好进行 CI/CD 构建。</strong></p>
</div>
```

---

## 📌 关键修改点总结

### 在当前 HTML 文档中的具体位置：

| 位置 | 修改内容 | 参考行号 |
|------|--------|--------|
| 文档标题下方 | 添加注释说明本文针对 Rocky 9.7 + 第 0 阶段准备 | ~45 |
| 第 1 阶段开始之前 | 插入新的"第 0 阶段"完整 HTML 段落 | ~320 |
| 硬盘空间分配表格 | 添加注脚说明 LVM/XFS 兼容性 | ~380 |
| 页脚之前 | 添加新的"第 8 阶段"验证部分 | ~1800 |
| 文档最后 | 更新创建日期和版本信息 | ~1900 |

---

## 🛠️ 改写方式

### **推荐方式 1: 使用 HTML 编辑器（最安全）**

1. 用记事本或 VS Code 等打开 HTML 文件
2. 找到以下位置：
   - `<h2>💡 硬件配置与性能分析</h2>` 之前插入第 0 阶段
   - `<h2>🛠️ 常用管理命令速查</h2>` 之后插入第 8 阶段
3. 添加新的 HTML 段落内容
4. 保存并在浏览器中测试显示效果

### **推荐方式 2: Python 或 Node.js 脚本自动改写**

（可以编写脚本自动注入 HTML，但鉴于文档的自定义性，手动改写更保险）

---

## 📖 生成的文档结构预览

改写后的 HTML 文档目录结构：

```
📄 GitHub Actions 自托管 Runner 完整部署指南（Rocky Linux 9.7）

💡 硬件配置与性能分析
  - 我的电脑规格
  - 这个配置能胜任什么
  - 运行时性能表现
  - 硬盘空间分布

🎯 前置要求与准备清单
  - 必需物品与权限

🎯 第 0 阶段: Rocky 9.4 CI/CD 环境准备 [新增]
  - 为什么需要第 0 阶段
  - 执行步骤
  - 验证安装

🚀 一键无人值守部署（第 1-7 阶段，保持不变）

📋 详细手动部署步骤（第 1-7 阶段，保持不变）

⚠️ 常见问题（保持不变）

🛠️ 常用管理命令速查（保持不变）

🔒 安全与最佳实践（保持不变）

🔄 第 8 阶段: 验证 CI/CD 兼容性 [新增]
  - 兼容性验证清单
  - 测试构建流程

📞 获取帮助（保持不变）
```

---

## ✅ 完成核实清单

改写完成后，请检查：

- [ ] 第 0 阶段完整详细，包括所有必要的安装步骤
- [ ] 第 8 阶段验证清单准确，涵盖关键工具
- [ ] 所有代码块都使用正确的 CSS class (`code-block`)
- [ ] 所有警告/提示使用正确的 info-box 样式
- [ ] 文档在 Chrome 和 Firefox 中显示正常
- [ ] 点击内部链接（如标题）能正确导航
- [ ] PDF 导出功能保持可用

---

## 📝 改写时间估计

- **手动编辑 HTML**: 30-45 分钟
- **浏览器测试**: 10-15 分钟
- **PDF 导出验证**: 5-10 分钟

**总计**: 约 1 小时
