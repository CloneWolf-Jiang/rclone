# apt-get Wrapper 参数处理修复说明

## 问题症状
工作流运行时出现错误：
```
未找到匹配的参数: false
未找到匹配的参数: true
Error: Process completed with exit code 100.
```

## 根本原因分析

在执行以下命令时：
```bash
sudo apt-get install -y fuse3 libfuse-dev rpm pkg-config git-annex git-annex-remote-rclone nfs-common
```

脚本的参数处理存在两个关键缺陷：

### 问题 1: 选项参数被当作包名查询
- 原始脚本接收参数：`"-y fuse3 libfuse-dev rpm pkg-config ..."`
- `convert_package_names` 函数会迭代所有参数，包括 `-y` 选项
- `-y` 不是包名，但被传递给 `get_package_mapping` 进行查询
- 当 jq 查询失败或返回意外值时，某些情况下会输出 "false" 或 "true"
- 这些值随后被传递给 `dnf`，导致错误

### 问题 2: 包名字符串未正确处理
- 原始脚本使用：`converted=$(convert_package_names "$@")` 得到字符串
- 然后调用：`dnf install -y $converted`（未引用的变量）
- 这种方式容易导致分词错误和特殊字符问题

## 修复方案

### 修复 1: 在 `convert_package_names` 中跳过选项参数

```bash
convert_package_names() {
    local -a converted_packages=()
    
    for pkg in "$@"; do
        # 跳过以 - 开头的选项参数（如 -y, --no-cache 等）
        if [[ "$pkg" == -* ]]; then
            converted_packages+=("$pkg")  # 保留选项，但不查询映射
            continue
        fi
        
        # 后续正常处理包名...
    done
}
```

**优势**：
- 选项参数被直接添加，不经过 jq 查询
- 消除了 "false"/"true" 输出的来源
- 保持了选项在输出中的位置

### 修复 2: 使用数组方式处理包名

```bash
install)
    local -a packages_array=()
    packages_array=($(convert_package_names "$@"))
    
    if [[ ${#packages_array[@]} -gt 0 ]]; then
        dnf install -y "${packages_array[@]}"  # 数组扩展，safer
        # ... 后续处理
    fi
    ;;
```

**优势**：
- 数组方式正确处理多个包名
- 避免了展开字符串时的分词问题
- 符合 bash 最佳实践
- 处理包含空格的包名更安全

### 修复 3: 同样修复到 `remove|purge` 命令

## 修改文件
- **文件**: `setup-rocky-9.4-ci-env-v3.1.sh`
- **版本**: v3.2.1 → v3.2.2
- **修改内容**:
  1. `convert_package_names` 函数：添加选项参数检测和跳过逻辑
  2. `install` 命令处理：使用数组方式替代字符串展开
  3. `remove|purge` 命令处理：使用数组方式替代字符串展开

## 测试验证

### 场景 1: 安装多个包（包含选项）
```bash
sudo apt-get install -y fuse3 libfuse-dev rpm pkg-config
```
**预期结果**：
- `-y` 选项被保留（但不导致错误）
- 包名正确转换并传递给 dnf
- 不再出现 "未找到匹配的参数: false" 错误

### 场景 2: 安装包含被忽略的包
```bash
sudo apt-get install -y git-annex git-annex-remote-rclone fuse3
```
**预期结果**：
- `git-annex` 和 `git-annex-remote-rclone` 被跳过（在忽略列表中）
- `fuse3` 正常处理和安装
- Exit code: 0（仅忽略跳过的包）

### 场景 3: 所有包都被忽略
```bash
sudo apt-get install -y git-annex git-annex-remote-rclone
```
**预期结果**：
- 所有包都被跳过
- 不调用 dnf（避免不必要的操作）
- Exit code: 0（不视为错误）

## 影响范围

### ✅ 直接改进
- 解决 "未找到匹配的参数: false/true" 错误
- 正确处理 apt-get 的 `-y` 选项
- 更安全的参数处理

### ✅ 间接改进
- 减少 jq 查询失败的可能性
- 提高脚本在各种输入下的鲁棒性
- 更易于维护和扩展

## 后续优化建议

1. **验证 jq 返回值**：在 `get_package_mapping` 中确保只输出有效的包名
2. **添加日志输出**：便于调试和验证参数转换过程
3. **单元测试**：为参数处理函数添加测试用例
4. **文档更新**：明确说明受支持的 apt-get 选项

## 相关链接
- GitHub Actions Run: 22220002065 (Original failure)
- Script Version: v3.2.2
- Configuration Files:
  - `package-map.json` (51 mappings)
  - `ignore-packages.json` (10 entries)

---
**修复时间**: 2026-02-20
**修复者**: GitHub Copilot
**验证状态**: ✅ 已应用修改，等待 Rocky runner 重新部署
