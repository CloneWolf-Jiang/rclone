# Rocky Linux ç¯å¢ƒè¡¥å……å…¼å®¹æ€§åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2026-02-20  
**ç‰ˆæœ¬**: v3.2 è¡¥å……åˆ†æ  
**ç›®æ ‡**: ç¡®ä¿è„šæœ¬æ”¯æŒ workflows ä¸­çš„æ‰€æœ‰åœºæ™¯

## ğŸ” é—®é¢˜åˆ†æ

### 1. Workflow å½“å‰é…ç½®é—®é¢˜

#### build.yml ä¸­çš„åº“å®‰è£…æ­¥éª¤

```yaml
- name: Install Libraries on Linux
  run: |
    sudo apt-get update
    sudo apt-get install -y fuse3 libfuse-dev rpm pkg-config git-annex git-annex-remote-rclone nfs-common
  if: matrix.os == 'ubuntu-latest'  # âš ï¸ åªå¯¹ ubuntu-latest æ‰§è¡Œ
```

#### å®é™… Job è¿è¡Œç¯å¢ƒ

| Job Name | OS Matrix | å®é™…ä½¿ç”¨çš„ Runner | åº“å®‰è£…æ˜¯å¦æ‰§è¡Œ |
|----------|-----------|------------------|-----------------|
| linux | ubuntu-latest | self-hosted | âŒ **ä¸æ‰§è¡Œ** |
| linux_386 | ubuntu-latest | self-hosted | âŒ **ä¸æ‰§è¡Œ** |
| other_os | ubuntu-latest | self-hosted | âŒ **ä¸æ‰§è¡Œ** |
| go1.24 | ubuntu-latest | self-hosted | âŒ **ä¸æ‰§è¡Œ** |
| lint | N/A | self-hosted | âŒ **ä¸æ‰§è¡Œ** |
| android | N/A | self-hosted | âŒ **ä¸æ‰§è¡Œ** |

**å…³é”®å‘ç°**ï¼š
- âš ï¸ **æ¡ä»¶ `if: matrix.os == 'ubuntu-latest'` æ£€æŸ¥çš„æ˜¯çŸ©é˜µå˜é‡ï¼Œä½†å®é™…runneræ˜¯self-hosted**
- ğŸ”´ **Rocky Linuxä¸Šçš„4ä¸ªbuild jobæ²¡æœ‰å®‰è£…å¿…è¦çš„åº“**
- ğŸ”´ **Lintå’ŒAndroid jobåœ¨self-hostedä¸Šå¯èƒ½ç¼ºå°‘ä¾èµ–**

### 2. Rocky Linux ç¼ºå°‘çš„åº“

æ ¹æ® build.yml çš„ "Install Libraries on Linux" æ­¥éª¤ï¼Œä»¥ä¸‹åº“åœ¨Rockyä¸Šç¼ºå¤±ï¼š

```
Ubuntu åŒ…              Rocky åŒ…/å¤‡æ³¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fuse3               âœ… å·²å®‰è£…ï¼ˆå¯é€‰ï¼‰
libfuse-dev         â†’ fuse3-devel âœ… å·²å®‰è£…
rpm                 âœ… å·²å®‰è£…ï¼ˆåŸºç¡€ç³»ç»Ÿï¼‰
pkg-config          â†’ pkgconf-pkg-config âœ… å·²å®‰è£…
git-annex           âŒ å¿½ç•¥åˆ—è¡¨ä¸­ï¼ˆä¸å¯ç”¨ï¼‰
git-annex-remote-rclone âŒ å¿½ç•¥åˆ—è¡¨ä¸­ï¼ˆä¸å¯ç”¨ï¼‰
nfs-common          â†’ nfs-utils âŒ **ç¼ºå¤±éªŒè¯ï¼**
```

### 3. Lint Job çš„é¢å¤–éœ€æ±‚

Lint job ä¸­éœ€è¦ä½†å¯èƒ½ç¼ºå¤±çš„ï¼š

```bash
# ä»£ç è´¨é‡æ£€æŸ¥éœ€è¦
golangci-lint (é€šè¿‡ action è‡ªåŠ¨å®‰è£…)    âœ…
govulncheck                           âš ï¸ éœ€è¦éªŒè¯
Python 3                              âœ… setup-rockyè„šæœ¬å·²å®‰è£…
markdownlint-cli2                     âš ï¸ éœ€è¦éªŒè¯ï¼ˆactionè‡ªåŠ¨å®‰è£…ï¼‰
```

### 4. Android Job çš„é¢å¤–éœ€æ±‚

```bash
# Android ç¼–è¯‘éœ€è¦
Go                                    âœ… setup-go action
Android NDK                           âŒ **éœ€è¦æ£€æŸ¥ï¼**
gobind/gomobile                       âš ï¸ é€šè¿‡è„šæœ¬å®‰è£…
LLVM/Clang                           âš ï¸ éœ€è¦éªŒè¯
```

## ğŸ“‹ å»ºè®®çš„è¡¥å……æªæ–½

### æ–¹æ¡ˆ Aï¼šä¿®æ”¹ Workflow æ¡ä»¶ï¼ˆæ¨èå¿«é€Ÿè§£å†³ï¼‰

ä¿®æ”¹ build.yml çš„åº“å®‰è£…æ¡ä»¶ï¼Œæ”¯æŒ self-hosted runner æ£€æµ‹ï¼š

```yaml
- name: Install Libraries on Linux
  run: |
    # æ£€æŸ¥æ˜¯å¦åœ¨ Rocky Linux ä¸Šè¿è¡Œ
    if [[ -f /etc/os-release ]]; then
      . /etc/os-release
      if [[ "$ID" == "rocky" ]]; then
        # Rocky å·²é€šè¿‡ setup-rocky-9.4-ci-env-v3.2.sh é…ç½®ï¼Œæ— éœ€é‡å¤å®‰è£…
        echo "Rocky Linux detected - libraries already configured by setup script"
        exit 0
      fi
    fi
    
    # Ubuntu ç¯å¢ƒæ‰§è¡Œ
    sudo apt-get update
    sudo apt-get install -y fuse3 libfuse-dev rpm pkg-config git-annex git-annex-remote-rclone nfs-common
  if: matrix.os == 'ubuntu-latest'
```

### æ–¹æ¡ˆ Bï¼šä¸º setup è„šæœ¬æ·»åŠ åº“éªŒè¯å’Œä¿®å¤åŠŸèƒ½ï¼ˆå¢å¼ºå¥å£®æ€§ï¼‰

åœ¨ setup-rocky-9.4-ci-env-v3.2.sh ä¸­æ·»åŠ ï¼š

```bash
# æ£€æŸ¥å¿…éœ€åº“æ˜¯å¦å·²å®‰è£…
verify_libraries() {
    local failed=0
    local required_libs=(
        "fuse3-devel:FUSE development"
        "pkgconf-pkg-config:Package config tool"
        "nfs-utils:NFS utilities"
        "gcc:GNU C compiler"
        "python3-devel:Python development"
    )
    
    for entry in "${required_libs[@]}"; do
        lib="${entry%%:*}"
        desc="${entry##*:}"
        if rpm -q "$lib" &>/dev/null; then
            echo "âœ… $desc ($lib) - installed"
        else
            echo "âŒ $desc ($lib) - NOT installed"
            ((failed++))
        fi
    done
    
    return $failed
}

# ä¿®å¤ç¼ºå¤±çš„åº“
fix_missing_libraries() {
    dnf install -y fuse3-devel pkgconf-pkg-config nfs-utils
}
```

### æ–¹æ¡ˆ Cï¼šæ·»åŠ åˆå§‹åŒ–æ£€æŸ¥å‘½ä»¤

æä¾›ç»™ç”¨æˆ·çš„å‘½ä»¤è¡Œå·¥å…·ï¼š

```bash
# æ£€æŸ¥ç¯å¢ƒçŠ¶æ€
apt-get config-info

# æ·»åŠ æ–°å‘½ä»¤
/opt/actions-runner/compat-scripts/apt-get verify-env
/opt/actions-runner/compat-scripts/apt-get fix-env
```

## ğŸ”§ å»ºè®®çš„è„šæœ¬è¡¥å……

### è¡¥å…… 1ï¼šç¯å¢ƒéªŒè¯å‡½æ•°

åœ¨ setup-rocky-9.4-ci-env-v3.2.sh çš„"å®Œæˆ"éƒ¨åˆ†æ·»åŠ ï¼š

```bash
# ============================================================================
# ç¯å¢ƒéªŒè¯å’Œä¿®å¤å‘½ä»¤ï¼ˆå¯åœ¨åç»­æ‰§è¡Œï¼‰
# ============================================================================

# åˆ›å»ºéªŒè¯è„šæœ¬
cat > "$COMPAT_SCRIPTS_DIR/verify-env" << 'EOF'
#!/bin/bash
# éªŒè¯ Rocky Linux CI ç¯å¢ƒå®Œæ•´æ€§

echo "=== Rocky Linux CI Environment Verification ==="
echo ""

# æ£€æŸ¥å…³é”®åº“
echo "Checking required libraries..."
required_packages=(
    "fuse3-devel"
    "pkgconf-pkg-config"
    "nfs-utils"
    "gcc"
    "gcc-c++"
    "python3-devel"
    "openssl-devel"
    "zlib-devel"
    "ncurses-devel"
)

failed_packages=()
for pkg in "${required_packages[@]}"; do
    if rpm -q "$pkg" &>/dev/null 2>&1; then
        echo "âœ… $pkg"
    else
        echo "âŒ $pkg - MISSING"
        failed_packages+=("$pkg")
    fi
done

# æ£€æŸ¥å·¥å…·
echo ""
echo "Checking required tools..."
tools=(
    "gcc:gcc"
    "g++:g++"
    "make:make"
    "pkg-config:pkgconf-pkg-config"
    "git:git"
    "curl:curl"
    "jq:jq"
    "dnf:dnf"
    "python3:python3"
)

for entry in "${tools[@]}"; do
    cmd="${entry%%:*}"
    pkg="${entry##*:}"
    if command -v "$cmd" &>/dev/null; then
        version=$($cmd --version 2>&1 | head -n1)
        echo "âœ… $cmd: $version"
    else
        echo "âŒ $cmd - NOT FOUND"
    fi
done

# æ£€æŸ¥ apt-get wrapper
echo ""
echo "Checking apt-get wrapper..."
if [[ -x /usr/bin/apt-get ]]; then
    echo "âœ… /usr/bin/apt-get is executable"
    /usr/bin/apt-get --version
else
    echo "âŒ /usr/bin/apt-get not found or not executable"
fi

# JSON é…ç½®æ£€æŸ¥
echo ""
echo "Checking JSON configuration files..."
COMPAT_SCRIPTS_DIR="/opt/actions-runner/compat-scripts"
if [[ -f "$COMPAT_SCRIPTS_DIR/package-map.json" ]]; then
    if jq . "$COMPAT_SCRIPTS_DIR/package-map.json" &>/dev/null; then
        echo "âœ… package-map.json is valid JSON"
    else
        echo "âŒ package-map.json is invalid JSON"
    fi
else
    echo "âŒ package-map.json not found"
fi

if [[ -f "$COMPAT_SCRIPTS_DIR/ignore-packages.json" ]]; then
    if jq . "$COMPAT_SCRIPTS_DIR/ignore-packages.json" &>/dev/null; then
        echo "âœ… ignore-packages.json is valid JSON"
    else
        echo "âŒ ignore-packages.json is invalid JSON"
    fi
else
    echo "âŒ ignore-packages.json not found"
fi

# æ€»ç»“
echo ""
if [[ ${#failed_packages[@]} -gt 0 ]]; then
    echo "âŒ VERIFICATION FAILED - Missing packages:"
    for pkg in "${failed_packages[@]}"; do
        echo "   - $pkg"
    done
    echo ""
    echo "Run: sudo dnf install -y ${failed_packages[@]}"
    exit 1
else
    echo "âœ… VERIFICATION PASSED - Environment is complete"
    exit 0
fi
EOF
chmod +x "$COMPAT_SCRIPTS_DIR/verify-env"
```

### è¡¥å…… 2ï¼šä¸€é”®ä¿®å¤å‘½ä»¤

```bash
# åˆ›å»ºä¿®å¤è„šæœ¬
cat > "$COMPAT_SCRIPTS_DIR/fix-env" << 'EOF'
#!/bin/bash
# ä¿®å¤ç¼ºå¤±çš„åº“æˆ–å·¥å…·

echo "=== Fixing Rocky Linux CI Environment ==="
echo ""

# è¿è¡ŒéªŒè¯
if "$SCRIPT_DIR/verify-env"; then
    echo "âœ… Environment is already complete"
    exit 0
fi

echo ""
echo "Installing missing packages..."

# å®‰è£…ç¼ºå¤±çš„åº“
missing_packages=()

required_packages=(
    "fuse3-devel"
    "pkgconf-pkg-config"
    "nfs-utils"
    "gcc"
    "gcc-c++"
    "python3-devel"
    "openssl-devel"
    "zlib-devel"
    "ncurses-devel"
)

for pkg in "${required_packages[@]}"; do
    if ! rpm -q "$pkg" &>/dev/null 2>&1; then
        missing_packages+=("$pkg")
    fi
done

if [[ ${#missing_packages[@]} -gt 0 ]]; then
    sudo dnf install -y "${missing_packages[@]}"
    echo "âœ… Installation complete"
else
    echo "âœ… All required packages are already installed"
fi

# é‡æ–°éªŒè¯
echo ""
"$SCRIPT_DIR/verify-env"
EOF
chmod +x "$COMPAT_SCRIPTS_DIR/fix-env"

# æ·»åŠ è¿™ä¸¤ä¸ªè„šæœ¬åˆ° PATH
ln -sf "$COMPAT_SCRIPTS_DIR/verify-env" /usr/local/bin/verify-rocky-ci-env
ln -sf "$COMPAT_SCRIPTS_DIR/fix-env" /usr/local/bin/fix-rocky-ci-env
```

## ğŸ“ å¯¹ Workflow çš„å»ºè®®ä¿®æ”¹

### ä¿®æ”¹ 1ï¼šåœ¨ build job ä¸­æ·»åŠ ç¯å¢ƒéªŒè¯

åœ¨ build.yml ä¸­æ·»åŠ ä¸€ä¸ªæ–°æ­¥éª¤ï¼š

```yaml
- name: Verify CI environment on self-hosted runner
  run: |
    if command -v verify-rocky-ci-env &>/dev/null; then
      echo "Verifying Rocky Linux CI environment..."
      verify-rocky-ci-env
    fi
  if: ${{ runner.name == 'self-hosted' || contains(runner.name, 'rocky') }}
  continue-on-error: true
```

### ä¿®æ”¹ 2ï¼šæ¡ä»¶åŒ–åº“å®‰è£…

æ”¹è¿›åº“å®‰è£…æ­¥éª¤çš„æ¡ä»¶ï¼š

```yaml
- name: Install Libraries on Linux
  run: |
    # æ£€æŸ¥ç³»ç»Ÿç±»å‹
    if [[ -f /etc/os-release ]]; then
      . /etc/os-release
      if [[ "$ID" == "rocky" ]]; then
        # Rocky Linux å·²é€šè¿‡ setup è„šæœ¬é…ç½®
        # ä»…éªŒè¯
        if command -v verify-rocky-ci-env &>/dev/null; then
          echo "Verifying Rocky Linux environment..."
          verify-rocky-ci-env || fix-rocky-ci-env
        fi
        exit 0
      fi
    fi
    
    # Ubuntu ç¯å¢ƒæ‰§è¡Œæ ‡å‡†å®‰è£…
    sudo modprobe fuse
    sudo chmod 666 /dev/fuse
    sudo chown root:$USER /etc/fuse.conf
    sudo apt-get update
    sudo apt-get install -y fuse3 libfuse-dev rpm pkg-config git-annex git-annex-remote-rclone nfs-common
  if: matrix.os == 'ubuntu-latest'
```

## âœ… è¡¥å…… Summary

### éœ€è¦æ·»åŠ åˆ° setup-rocky-9.4-ci-env-v3.2.sh çš„å†…å®¹

1. âœ… **verify-env è„šæœ¬** - æ£€æŸ¥ç¯å¢ƒå®Œæ•´æ€§
2. âœ… **fix-env è„šæœ¬** - ä¿®å¤ç¼ºå¤±çš„åº“
3. âœ… **ç¬¦å·é“¾æ¥** - ä¾¿äºç”¨æˆ·åœ¨å‘½ä»¤è¡Œä½¿ç”¨
4. âœ… **è¾“å‡ºä¿¡æ¯** - æ˜¾ç¤ºå¦‚ä½•ä½¿ç”¨æ–°å‘½ä»¤

### éœ€è¦ä¿®æ”¹çš„ build.yml æ¡ä»¶

1. âš ï¸ æ”¹è¿›"Install Libraries on Linux"æ­¥éª¤çš„æ¡ä»¶æ£€æµ‹
2. âš ï¸ æ·»åŠ å¯¹ self-hosted runner çš„éªŒè¯æ­¥éª¤
3. âš ï¸ ç¡®ä¿ Lint å’Œ Android job ä¹Ÿèƒ½æ­£ç¡®éªŒè¯ç¯å¢ƒ

### v3.2 è„šæœ¬å½“å‰è¦†ç›–çš„èŒƒå›´

âœ… åŸºç¡€å·¥å…·å®‰è£…  
âœ… ç¼–è¯‘å·¥å…·é“¾  
âœ… å¼€å‘åº“  
âœ… å¯é€‰åº“  
âœ… FUSE é…ç½®  
âœ… Runner æƒé™é…ç½®  
âœ… apt-get wrapper + JSON é…ç½®  
âš ï¸ **ç¼ºå°‘ç¯å¢ƒéªŒè¯å’Œä¿®å¤åŠŸèƒ½**  
âš ï¸ **ç¼ºå°‘ä¸ workflow çš„é›†æˆæŒ‡è€ƒè™‘**

---

**å»ºè®®ä¼˜å…ˆçº§**:
1. ğŸ”´ **é«˜ä¼˜å…ˆçº§**: æ·»åŠ  verify-env å’Œ fix-env è„šæœ¬
2. ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**: æ›´æ–° build.yml æ¡ä»¶
3. ğŸŸ¢ **ä½ä¼˜å…ˆçº§**: æ·»åŠ æ–‡æ¡£å’Œæœ€ä½³å®è·µæŒ‡å—
